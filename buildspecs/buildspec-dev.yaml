version: 0.2

phases:
  install:
    commands:
      - echo Installing Serverless...
      - npm install -g serverless
  pre_build:
    commands:
      - echo Installing NPM dependencies...
      - npm install
  build:
    commands:
      - npm test
      # create directory for deployment packages
      - mkdir artifacts
      # create staging deployment package
      - mkdir artifacts/stg
      - serverless package --package artifacts/dev --stage Dev --verbose
      # create production deployment package
      - mkdir artifacts/prd
      - serverless package --package artifacts/prod --stage Prd --verbose
  post_build:
    commands:
      - echo Deployment successful

  #tell CodeBuild to save the artifacts directory as a build artifact, so it can be used by later stages in our pipeline
  artifacts:
    files:
      - artifacts /**/* # tells CodeBuild to save anything in our artifacts directory or its subdirectories
      - serverless.yml
      - deploy.sh #  deployment script
